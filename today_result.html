<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>hoge</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=RocknRoll+One&display=swap" rel="stylesheet">
        <style>
            body { 
            
            background-color: rgba(0, 0, 0, 0.99);
            margin: 0px;
            padding: 0px;
            overflow: hidden;
            font-family: 'RocknRoll One', sans-serif;
            color:#aaddff;   
            font-size: 64px;
            color: #fff;
            text-shadow: 6px 6px 0 #000,
                         -2px 2px 0 #000,
                         2px -2px 0 #000,
                         -2px -2px 0 #000;
            }
            :root{
                --num: 20;
                --skip-no-update: 0; /* 1:更新のない行を飛ばす */
            }
            div#all{
                min-height:1480px;
                background-color: rgba(0, 0, 0, 0.9);
                border: 4px solid #2222aa;
                overflow: hidden;
                /*
                background-image: url("stat_bg.png");
                background-repeat: repeat;
                background-size: cover;
                background-position: center;
                background-blend-mode:overlay;
                */
            }
            /* タイトル部分 */
            table#title {
                color: #aaddff;
                background-color: rgba(0, 0, 100, 0.95);
                background-color: #222;
                background: linear-gradient(
                    180deg
                    ,rgba(0,0,60,0.9)
                    ,rgba(12,42,77,0.9)
                );
                font-size: 64px;
                line-height: 130%;
                width:100%;
                padding-top: 20px;
                padding-left: 20px;
            }
            table#info {
                background: linear-gradient(
                    180deg
                    ,rgba(12,42,77,0.9)
                    ,rgba(35,85,155,0.9)
                );
                font-size: 64px;
            }
            table#title td {
                font-family:"LINE Seed JP App_TTF ExtraBold";
            }
            table#title td {
                font-size: 96px;
                color: #ffffff;
            }
            table#info tr:nth-child(1) {
                font-size: 45px;
            }
            table#title tr:nth-child(2) {
                font-size: 60px;
            }
            table#info td{
                text-align: center;
                vertical-align: top;
                width: 500px;
            }
            table#info tr:nth-child(1) td{
                color: #77ddff;
            }
            table#info td:nth-child(8){
            	overflow:hidden;
            	text-overflow:ellipsis;
            	max-width:90px;
            }
            /* リザルト部分 */
            table#result {
                overflow: hidden;
            	width:100%;
            	height:100%;
            }
            table#result td {
            	white-space:nowrap;
            }
            table#result tr:nth-child(even) td{
                color: #aaaaaa;
                font-size: 30px;
                text-align: center;
            }
            table#result td:nth-child(1) {
            	width:225px;
                color: #ffddaa;
                text-align: center;
                padding-right:20px;
            }
            table#result td:nth-child(2) {
            	width:40px;
                padding-right:20px;
            }
            table#result td:nth-child(3) {
            	overflow:hidden;
            	text-overflow:ellipsis;
            	max-width:90px;
                color: #bbffee;
            }
            table#result td:nth-child(4) {
                color: #aa22aa;
            	width:12%;
                text-align: right;
                padding-right: 20px;
            }
            table#result td:nth-child(5) {
            	width:10%;
                text-align: center;
                font-size:30px;
            }
            table#result td:nth-child(6) { /* bp */
                color: #ccffcc;
            	width:10%;
                text-align: right;
                font-size:50px;
            }
            table#result td:nth-child(7) { /* diff_bp */
                color: #aaaaaa;
            	width:8%;
                text-align: center;
                font-size:30px;
            }
            .MAX{
                animation-name: flashmax;
                animation-duration: 0.4s;
                animation-iteration-count: infinite;
            }
            @keyframes flashmax {
                0%   { color: #ff2828; }
                20%  { color: #d5ff28; }
                40%  { color: #28ff7e; }
                60%  { color: #2872ff; }
                80%  { color: #d528ff; }
                100% { color: #ff2828; }
            }
            .AAA{
                color:#ffff28;
            }
            .AA{
                color:#cccccc;
            }
            .A{
                color:#2ddf71;
            }
            .B{
                color:#aa22aa;
            }
            .C{
                color:#aa22aa;
                font-size: 0px; /* この行を消せば初Cも表示 */
            }
            .D{
                color:#aa22aa;
                font-size: 0px; /* この行を消せば初Dも表示 */
            }
            .E{
                color:#aa22aa;
                font-size: 0px; /* この行を消せば初Eも表示 */
            }
            .F{
                color:#aa22aa;
                font-size: 0px; /* この行を消せば初Fも表示 */
            }
            .perfect{
                animation-name: flashperfect;
                animation-duration: 0.2s;
                animation-iteration-count: infinite;
            }
            @keyframes flashperfect {
                0%   { background-color: #ffff77; }
                25%  { background-color: #dddd33; }
                50%  { background-color: #aaaa00; }
                75%  { background-color: #dddd33; }
                100% { background-color: #ffff77; }
            }
            .fc{
                animation-name: flashfc;
                animation-duration: 0.2s;
                animation-iteration-count: infinite;
            }
            @keyframes flashfc {
                0%   { background-color: #ff2828; }
                20%  { background-color: #d5ff28; }
                40%  { background-color: #28ff7e; }
                60%  { background-color: #2872ff; }
                80%  { background-color: #d528ff; }
                100% { background-color: #ff2828; }
            }
            .failed{
                animation-name: flashfailed;
                animation-duration: 0.08s;
                animation-iteration-count: infinite;
            }
            @keyframes flashfailed {
                0%   { background-color: #ff2828; }
                50%  { background-color: #282828; }
                100% { background-color: #ff2828; }
            }
            .ac{background-color: #ff66ff;}
            .ec{background-color: #22ff22;}
            .nc{background-color: #22ccff;}
            .hc{background-color: #ffffff;}
            .exh{
                animation-name: flashexh;
                animation-duration: 0.08s;
                animation-iteration-count: infinite;
            }
            @keyframes flashexh {
                0%   { background-color: #ff2828; }
                50%  { background-color: #ffff28; }
                100% { background-color: #ff2828; }
            }
            .updated{ color: #ffcccc} /* BPやスコアの更新した場合につける色*/
            .stats_main{ /* 統計情報 目立つ方のやつ */
                color: #ffffaa;
            } 
            .stats_sub{ /* 統計情報 目立つ方のやつ */
                color: #aaffdd;
                font-size:45px;
            } 
            /* SP☆12地力表用のスタイル */
            sp12hard{
                color:#ff86b4;
                padding: 0px;
                font-size: 50px;
            }
            sp12clear{
                color:#9ee7ff;
                padding: 0px;
                display: none;
                font-size: 50px;
            }
        </style>
    <body>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script>
        function loadXml() {
            var getxml = $.ajax({
                url: './history.xml',
                type: 'GET',
                dataType: 'xml',
                cache: false
            });
            getxml.done(function(xml){
                // xmlデータからほしいデータをfindで探し処理
                var out = "";
                var notes = $(xml).find('Items notes');
                var date = $(xml).find('Items date').text();
                var playtime = $(xml).find('Items playtime').text();
                var pace = $(xml).find('Items pace').text();
                var playcount = $(xml).find('Items playcount').text();
                var maxnum = getComputedStyle(document.documentElement).getPropertyValue('--num');
                var skip_no_update = getComputedStyle(document.documentElement).getPropertyValue('--skip-no-update');

                var update_lamp = 0;
                var update_score = 0;
                var update_bp = 0;
                //var skip_no_update=1;

                $($(xml).find("Items Result").get().reverse()).each(function(index, item){
                    var lv = $(item).find('lv').text();
                    var title = $(item).find('title').text();
                    var lamp       = parseInt($(item).find('lamp').text());
                    var pre_lamp   = parseInt($(item).find('pre_lamp').text());
                    var score      = parseInt($(item).find('score').text());
                    var bp         = parseInt($(item).find('bp').text());
                    var pre_score  = parseInt($(item).find('pre_score').text());
                    var pre_bp     = parseInt($(item).find('pre_bp').text());
                    var diff_score = $(item).find('diff_score').text();
                    var diff_bp    = $(item).find('diff_bp').text();
                    var score_rate = parseFloat($(item).find('score_rate').text());
                    var org_lamp   = lamp;
                    var org_pre_lamp = pre_lamp;
                    if (lamp > pre_lamp){update_lamp += 1;}
                    if (score > pre_score){update_score += 1;}
                    if (bp < pre_bp){update_bp += 1;}
                    if (lamp == 0){
                        lamp = ''
                    }
                    else if (lamp < 3){
                        lamp = '<span class="failed">　</span>'
                    }
                    else if (lamp == 3){
                        lamp = '<span class="ac">　</span>'
                    }
                    else if (lamp == 4){
                        lamp = '<span class="ec">　</span>'
                    }
                    else if (lamp == 5){
                        lamp = '<span class="nc">　</span>'
                    }
                    else if (lamp == 6){
                        lamp = '<span class="hc">　</span>'
                    }
                    else if (lamp == 7){
                        lamp = '<span class="exh">　</span>'
                    }
                    else if (lamp == 8){
                        lamp = '<span class="fc">　</span>'
                    }
                    else if (lamp == 9){
                        lamp = '<span class="perfect">　</span>'
                    }

                    if (score_rate > 88.88){
                        score = '<span class="AAA">'+score+'</span>';
                    }
                    else if (score_rate > 77.77){
                        score = '<span class="AA">'+score+'</span>';
                    }
                    else if (score_rate > 66.66){
                        score = '<span class="A">'+score+'</span>';
                    }
                    else {
                        score = '<span class="B">'+score+'</span>';
                    }
                    if (diff_score.includes('+')){
                        diff_score = '<span class="updated">'+diff_score+'</span>';
                    }
                    if (diff_bp.includes('-')){
                        diff_bp = '<span class="updated">'+diff_bp+'</span>';
                    }
                    // テーブルに追加
                    if (index == maxnum){ // 直近のmaxnum曲だけ表示
                        return false;
                    }
                    // 2段組にする
                    var one_result = "";
                    one_result += '<tr>';
                    one_result += '<td rowspan="2">'+lv+'</td>';
                    one_result += '<td rowspan="2">'+lamp+'</td>';
                    one_result += '<td rowspan="2">'+title+'</td>';
                    one_result += '<td rowspan="2">'+score+'</td>';
                    one_result += '<td>('+score_rate.toFixed(2)+'%)</td>';
                    one_result += '<td rowspan="2">'+bp+'</td>';
                    one_result += '<td rowspan="2">'+diff_bp+'</td>';
                    one_result += '</tr>';
                    // 2段目
                    one_result += '<tr>';
                    one_result += '<td>'+diff_score+'</td>';
                    one_result += '</tr>';

                    // スキップ処理
                    if (skip_no_update == 1){
                        //if ((!diff_score.includes('+')) && (!diff_bp.includes('-')) && (lamp < pre_lamp)){
                        if (diff_score.includes('-') & diff_bp.includes('+') & (org_lamp < org_pre_lamp)){
                            // skip
                        }else {
                            out += one_result;
                        }
                    }else{
                        out += one_result;
                    }
                    });
                //$('notes').html("notes: <span class='title_value'>" + notes + "</span>");
                $('notes').html(notes);
                $('date').html(date);
                //$('playcount').html("&nbsp;&nbsp;&nbsp;&nbsp;plays: <span class='title_value'>" + playcount + '</span>');
                $('playcount').html(playcount);
                if (pace == "0"){ // playtime,paceを書かない
                    $('header_3').html('lamp');
                    $('header_4').html('score');
                    $('header_5').html('bp');
                    $('header_6').html('');
                    $('header_7').html('');
                    $('value_3').html('<span class="stats_sub">+'+update_lamp+'</span>');
                    $('value_4').html('<span class="stats_sub">+'+update_score+'</span>');
                    $('value_5').html('<span class="stats_sub">+'+update_bp+'</span>');
                    $('value_6').html('');
                    $('value_7').html('');
                }else{
                    $('header_3').html('playtime');
                    $('header_4').html('pace');
                    $('header_5').html('lamp');
                    $('header_6').html('score');
                    $('header_7').html('bp');
                    $('value_3').html('<span class="stats_main">'+playtime+'</span>');
                    $('value_4').html('<span class="stats_sub">'+pace+'</span>');
                    $('value_5').html('<span class="stats_sub">+'+update_lamp+'</span>');
                    $('value_6').html('<span class="stats_sub">+'+update_score+'</span>');
                    $('value_7').html('<span class="stats_sub">+'+update_bp+'</span>');

                }
                $('#result tbody').html(out);
            });
            getxml.fail(function(err) {
                // alert('failed');
            });
        }

        window.addEventListener('DOMContentLoaded', function() {
            var roopTimer = setInterval(loadXml, 1000);
        });

</script>
</head>
<body>
  <div id="all">
    <table id="title">
      <tr>
        <td><date></date></td>
      </tr>
    </table>
    <table id="info">
        <!--TODO 列の中身を固定せず、spanでスタイルを指定してタイトルとともに変数として書く(pace0でもレイアウトが崩れないように)-->
      <tr>
        <td>notes</td><td>plays</td>
        <td><header_3></header_3></td>
        <td><header_4></header_4></td>
        <td><header_5></header_5></td>
        <td><header_6></header_6></td>
        <td><header_7></header_7></td>
        <td></td>
      </tr>
      <tr>
        <td><span class="stats_main"><notes></notes></span></td>
        <td><span class="stats_main"><playcount></playcount></span></td>

        <td><value_3></value_3></td>
        <td><value_4></value_4></td>
        <td><value_5></value_5></td>
        <td><value_6></value_6></td>
        <td><value_7></value_7></td>
        <td></td>
      </tr>
    </table>
    <table id="result">
      <tbody>
      </tbody>
    </table>
  </div>
</body>
</html>